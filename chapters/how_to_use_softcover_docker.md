# How to use the Softcover Docker image to publish your book

This article will show you how to use the softcover docker image to develop and publish your book or article to the softcover.io service.

A Docker image with the softcover tools pre installed was built by one of the softcover team members.

I was able to use this Docker image to build and publish my book (in progress) to the platform.

In this article I want to share the docker and softcover CLI commands that I am using to develop and publish my books and articles on softcover.io.

The article assumes that you have Docker installed on your machine.

You can download and install Docker desktop from [here](https://docs.docker.com/desktop/mac/install).

## Pulling the Softcover Docker image

The first thing you want to do is pull down the image from Docker hub. It is a fairly large image so be warned that it will take a bit of time and space.

The image is hosted [here](https://hub.docker.com/r/softcover/softcover) and its Github repo is available [here](https://github.com/softcover/softcover-docker)

We can pull the image using the following Docker command:

```console
docker pull softcover/softcover
```

This command will pull the latest softcover Docker image onto our machine.

## Creating a new book

Now that we have the image downloaded we can run the softcover command to create our book through Docker.

But first let's setup a directory to hold all our books:

```console
mkdir mybooks && cd mybooks
```

From within this directory we can run the following Docker command to create a new book:

```console
docker run --rm -v `pwd`:/book softcover/softcover:latest sc new mybook
```

Here we have told the container to run the softcover `sc new` command to create a new book named `mybook`.

The command will create a new directory named `mybook` in the current directory of our local machine.

Note that Although we have not specified a working directory option on the command line, the Docker image [Dockerfile](https://github.com/softcover/softcover-docker/blob/master/Dockerfile) specifies a `/book` working directory.

This is why we have specified a volume map command line option (-v) that maps the current directory `pwd` to the `/book` directory in the container.

With this mapping in place, when we run the container `sc new mybook` command, the `mybook` directory is created in the container's `/book` working directory.

Since the working directory is volume mapped to our local current directory, its content will be reflected in the current directory. Therefore this results in the `mybook` directory to be created in our current directory.

In the event that we want to create an article instead of a book, we would just need to add the `-a` option to the `sc new` command:

```console
docker run --rm -v `pwd`:/book softcover/softcover:latest sc new -a myarticle
```

## Exploring the book directory

Now that we have created our new book, let's move into the `mybook` directory and explore its content:

```console
cd mybook
```

The softcover documentation available [here](https://manual.softcover.io/book) provides detailed explanation of the content of this directory.

For our purposes, I will just provide enough detail so we can understand how the book building and publishing commands in the following sections work.

The mybook directory contains a `Book.txt` file that specifies the table of contents, the preface and the individual book chapters of a published book.

Let's look at the contents of this file by running the following command:

```console
cat book.txt
```

The output shows the file content:

```console
cover
frontmatter:
maketitle
tableofcontents
preface.md
mainmatter:
a_chapter.md
another_chapter.md
yet_another_chapter.md
```

We can see a number of markdown files (files with the .md extension) listed in this file.

All these markdown files will have a corresponding file of the same name in the `./chapters` directory.

Let's list the contents of the chapters directory:

```console
ls -l chapters
```

We can see the default content that the `sc new` command generated for us:

```console
a_chapter.md
another_chapter.md
preface.md
yet_another_chapter.md
```

As you can see the chapters directory contains the same set of markdown files listed in the `Book.txt` file.

These files are the source files that are used to generate the html and ebook formatted files of our published book.

The order of the chapter files listed under the `mainmatter:` section of the `Book.txt` file determines their corresponding chapter order in the published html or ebook.

The `preface.md` file can be edited to provide your own custom preface content for your book and the table of content is autogenerated for you.

Note that if we create an article instead of a book, there would only be a single chapter file in the `Book.txt` file.

Here is the content of the `Book.txt` file when we create an article:

```console
cover
maketitle
an_article.md
```

Correspondingly, the `chapters` directory for an article contains the single markdown file listed in the `Book.txt` file.

Notice that preface or table of contents does not exist for an article as well.

## Building html files

As we add, remove and edit markdown files in the chapters directory, we might want to build and preview the content in a web browser.

One way to do this is to build the html files using the `sc build:html` command.

To do so using our docker image we can run the following Docker command from within the `mybook` directory:

```console
docker run --rm -v `pwd`:/book softcover/softcover:latest sc build:html
```

This command uses the markdown files in `./chapters` directory mapped to the `/book/chapters` directory of the container as source files. For each source file, It builds corresponding html output files in the `/book/html` directory of the container, which are reflected back to our local `./html` directory.

The html generator also generates a `mybook.html` file which includes the html content of all the individual chapters, compiled into a single html file.

Here is the content of the `html` directory after running the `sc build:html` command.

```console
a_chapter.html
a_chapter_fragment.html
another_chapter.html
another_chapter_fragment.html
frontmatter.html
frontmatter_fragment.html
images -> ../images
mybook.html
stylesheets
yet_another_chapter.html
yet_another_chapter_fragment.html
```

In addition to the `mybook.html` file and html files for each chapter, there are generated fragment files for each chapter that contain only the content of the html body.

There is also a stylesheet directory and a symlink to the images directory of the parent directory. This is where you can make changes to the styles and media content that are referenced from the generated html files.

We can view the `mybook.html` file from our local `./html` directory, by using a web browser to open the file.

## Serving generated html book

In addition to building the html files we can not only build the files, but also serve the `mybook.html` file to our local web browser by running the following command instead:

```console
docker run --rm -v `pwd`:/book -d -p 4000:4000 softcover/softcover:latest sc server
```

The above docker command runs the `sc server` softcover command in the container.

The command internally runs the `sc build:html` to build the `mybook.html` file in the `/book/html` directory of the container, then starts up a web server inside the container that serves the `/book/html/mybook.html` file through port 4000 of the container.

Since the docker command maps the container port 4000 to our local port 4000, we can navigate to localhost:4000 with our local web browser to view the html content of the `/book/html/mybook.html` file served through the container.

> The port number 4000 is exposed in the [Dockerfile](https://github.com/softcover/softcover-docker/blob/master/Dockerfile).

As we change the markdown content of the local `chapters` directory, the changes are reflected back to the `/book/chapters` directory of the container.

This change is detected in the container (via an installed monitoring process in the container) and the `sc build:html` command is re-run to regenerate updated html files. The web server is then reloaded, allowing us to instantly preview the output of our changes in our local web browser.

Of course we can always manually run the `sc build:html` command using the container to force a regeneration of the html content.

> Tip: since running the `sc server` command also builds the html files, you don't need to run the `sc build:html` command before running `sc server` for the first time.

## Resolving issues with the softcover server

In some situations you might run into an issue where the server running in the container will hang or the container main process, and hence the container itself, will exit.

This might happen when you rename the chapter markdown files where the names get out of sync with the `Book.txt` file.

It could also happen if there is an error in the markdown file that causes a markdown file parsing error by the `sc build:html` command.

In this scenario manually executing the Docker `sc build:html` command will display the errors so you can debug and fix the issue.

To check if the container exited you can run this Docker command:

```console
docker ps -a
```

This command will show all running and stopped containers on your system.

If the container has exited you can fix the issue by using the `sc build:html` command and afterwards run the `sc server` command again to start the container.

If the container has not exited, you can fix the issue and see if the server starts working again.

If not, then first stop the container first using the command below:.

```console
docker stop <container-id>
```

Then run the `sc server` command again to start the container back up.

You can see the running container id by executing the following docker command:

```console
docker ps -a
```

## Publishing the book to softcover.io

In order to publish your html and ebook content to softcover.io, you need to login to the service and then issue the softcover CLI publishing commands.

Because of the need to login, the only way you can accomplish this using Docker is to interactively log into the running container bash shell and then from there log into softcover.io to run the publishing commands.

To run the container in interactive mode we need to use the `-it` option and execute the bash command:

```console
docker run --rm -it -v `pwd`:/book softcover/softcover:latest bash
```

This will drop us into the container in the `/book` working directory as command prompt shows:

```console
root@15cf54a5bec5:/book#
```

We can run the following commands in the interactive shell to login, build and publish to the softcover.io service:

```console
sc login
sc clean
# builds all the book formats
sc build:all
# builds a preview version of the book using the page ranges in the config/book.yml file
# omit this command when building an article
sc build:preview
#publish to softcover.io
sc publish
sc logout
#exit the container
exit
```

We can re-run these commands anytime we wish to update our published book on the softcover.io service.

As an alternative, we can run `sc deploy` command instead of the individual build and publish commands:

```console
sc login
sc clean
# the sc deploy command calls the build:all, build:preview and sc publish
sc deploy
sc logout
exit
```

The `sc deploy` command internally calls the build:all, build:preview and publish commands based on the configuration in the `.softcover-deploy` file.

For example you can customize the `sc deploy` command for publishing an article to not execute the `sc build:preview` command. See [here](https://manual.softcover.io/book/customization#sec-customizing_deploys) for further details.

> Refer to softcover documentation for full description of all commands.

Once we are done publishing, we exit the bash shell by typing `exit` which will terminate the bash session and the container process.

## Inspecting the published content

Normally if we were logging into softcover by executing the `sc login` command from our host machine we could navigate to the softcover.io service using our web browser and be automatically logged in.

However since we logged in from a container instead, we will need to manually log into the softcover website to be able to see our published book or article.

Once you are logged in, you can browse all your published content.

## Conclusion

In this article I showed you how you can use the softcover docker container to build, locally serve and publish your book or article to the softcover.io service.

By using the softcover docker image, you don't have to deal with any installation and upgrade issues with the softcover CLI tooling. Furthermore you don't have to modify your development environment with additional tooling that you don't want to have permanently installed.
